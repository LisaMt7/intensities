(()=>{var y=class{get in(){return this.nodes[0]}constructor(e){this.context=null,this.info=e,this.nodes=[],this.analyser=null,this.out=null,this.canListen=!1,this.analyses={},this.integrations={}}analyse=()=>{for(let e in this.analyses)this.analyses[e].output=this.analyses[e].function();for(let e in this.integrations)this.integrations[e].output=this.integrations[e].function()};initializeContext=()=>{if(!this.context){if(setInterval(this.analyse,50),this.context=new(window.AudioContext||window.webkitAudioContext),this.info.minFreq){let e=this.context.createBiquadFilter();this.nodes.push(e),e.type="highpass",e.frequency.value=this.info.minFreq}if(this.info.maxFreq){let e=this.context.createBiquadFilter();this.nodes.push(e),e.type="lowpass",e.frequency.value=this.info.maxFreq,this.nodes[this.nodes.length-1].connect(e)}this.analyser=this.createAnalyser(),this.nodes[this.nodes.length-1].connect(this.analyser),this.out=this.context.createGain(),this.out.gain.value=1,this.out.connect(this.context.destination)}};createAnalyser=(e=this.context)=>{let t=e.createAnalyser();return t.smoothingTimeConstant=this.info.smoothingTimeConstant,t.fftSize=this.info.fftSize,t.minDecibels=this.info.minDecibels,t.maxDecibels=this.info.maxDecibels,t};cloneAudioBuffer=e=>{let t=new AudioBuffer({length:e.length,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate});for(let n=0;n<t.numberOfChannels;++n){let i=e.getChannelData(n);t.copyToChannel(i,n)}return t};fft=function(e,t,n){let i=new OfflineAudioContext(1,e.length,this.context.sampleRate),s=i.createScriptProcessor(1024,1,1);s.connect(i.destination);let o=this.createAnalyser(i),a=i.createBufferSource();a.connect(o);let f=[];s.onaudioprocess=function(l){let d=new Uint8Array(o.frequencyBinCount);o.getByteFrequencyData(d),typeof t=="function"&&t(d),f.push(d)},o.connect(s),a.buffer=e,a.onended=function(l){typeof n=="function"&&n(f)},a.start(),i.startRendering().then(l=>console.log("renderedBuffer",l)).catch(l=>console.log("Rendering failed: "+l))};addSource=(e,t=()=>{})=>{e.connect(this.in);let n=e.channelCount??e.buffer?.numberOfChannels;if(n>1){var i=this.context.createChannelSplitter(n);this.analyser.connect(i);var s=this.context.createChannelMerger(n);for(let r=0;r<n;r++){let g=t();g.container.insertAdjacentHTML("afterbegin",`<h3>${r==0?"Left":"Right"} Channel </h3>`);let h=this.context.createGain();h.gain.setValueAtTime(1,this.context.currentTime);let m=this.createAnalyser();i.connect(m,r),m.connect(h),h.connect(s,0,r),this.addAnalysis(m,"fft",g.spectrogram)}let o=(r,g)=>r.map((h,m)=>Math.abs(h-g[m])),a=t();a.container.insertAdjacentHTML("afterbegin","<h3>Additive</h3>");let f=(r,g)=>r.map((h,m)=>h+g[m]);this.integrate("additive",[0,1],r=>f(r[0].frequencies,r[1].frequencies),a.spectrogram,"data");let l=t();l.container.insertAdjacentHTML("afterbegin","<h3>Difference</h3>"),this.integrate("difference",[0,1],r=>o(r[0].frequencies,r[1].frequencies),l.spectrogram,"data");let d=this.context.createGain();s.connect(d),d.connect(this.out),this.canListen?d.gain.value=1:d.gain.value=0}else{let o=t(),a=this.context.createGain();this.analyser.connect(a),a.connect(this.out),this.canListen?a.gain.value=1:a.gain.value=0,this.addAnalysis(this.analyser,"fft",o.spectrogram)}video&&(video.onended=()=>{e.disconnect()}),e.start instanceof Function&&e.start()};addAnalysis=(e,t,n)=>{let i=()=>{};switch(t){case"fft":let s=new Uint8Array(e.frequencyBinCount);i=()=>{e.getByteFrequencyData(s);let a=Array.from(s);return n.updateData(a),{frequencies:a}};break;case"raw":let o=new Uint8Array(1);i=()=>{e.getByteTimeDomainData(o);let a=Array.from(o);return n.updateData([a]),{timeseries:a}};break}this.analyses[Object.keys(this.analyses).length]={function:i,output:null}};integrate=(e,t,n=o=>{},i,s)=>{this.integrations[e]={function:()=>{let o=n(t.map(a=>this.analyses[a].output));i[s]=o},output:null}};listen=(e=!this.canListen)=>{this.canListen=e}};console.log("window.visualscript:",visualscript);var H=document.getElementById("app"),q=document.getElementById("data"),D=document.getElementById("start"),b=document.getElementById("in"),C=document.getElementById("out"),A=document.getElementById("video"),S=document.getElementById("files"),G=document.getElementById("main"),E=document.getElementById("videos"),L=document.getElementById("analyses"),U=document.getElementById("test");var w=document.querySelector("visualscript-overlay"),v=document.createElement("div");w.insertAdjacentElement("beforeend",v);v.style=`
    width: 100%;
    height: 100%;
    display: flex;
    align-items:center;
    justify-content: center;
    font-size:170%;
    font-weight: bold;
    font-family: sans-serif;
  `;var T=Math.pow(2,11),I=7e3,M=0,j={smoothingTimeConstant:.2,fftSize:T,minDecibels:-127,maxDecibels:0,minFreq:I,maxFreq:M},u=new y(j);navigator.mediaDevices.enumerateDevices().then(F);var x={};function F(c){for(var e=0;e!==c.length;++e){var t=c[e],n=document.createElement("option");n.value=t.deviceId,t.kind==="audioinput"?(n.text=t.label||"Microphone "+(b.length+1),b.add(n)):t.kind==="audiooutput"?(n.text=t.label||"Speaker "+(C.length+1),C.add(n)):t.kind==="videoinput"&&(n.text=t.label||"Camera "+(A.length+1),A.add(n))}}var B=(c,e={})=>{let t=document.createElement("div");return t.classList.add("container"),L.insertAdjacentElement("beforeend",t),e.video&&(e.stream?(e.video.srcObject=e.stream,e.video.controls=!0,e.video.muted=!0):e.video.controls=!0,e.video.autoplay=!0),x[c]={container:t,video:e.video,stream:e.stream,spectrogram:new visualscript.streams.data.Spectrogram},t.insertAdjacentElement("beforeend",x[c].spectrogram),x[c]},p=0;S.onChange=async c=>{u.initializeContext(),p=0;for(let e of c.target.files){let t=e.type.split("/")[0],n,i;t==="video"?(i=document.createElement("video"),i.src=URL.createObjectURL(e),n=u.context.createMediaElementSource(i)):n=await k(e),i&&E.insertAdjacentElement("beforeend",i),u.addSource(n,()=>{let s=B(p,{video:i});return p++,s})}};D.onclick=()=>{u.initializeContext(),u.listen(!1),navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:b.value}},video:{exact:A.value}}).then(c=>{let e=document.createElement("video"),t=u.context.createMediaStreamSource(c);E.insertAdjacentElement("beforeend",e),u.addSource(t,()=>{let n=B(p,{video:e,stream:c});return p++,n})})};var k=c=>new Promise((e,t)=>{let n=new FileReader;n.onload=s=>{v.innerHTML="Decoding audio data from file...",w.open=!0,u.context.decodeAudioData(s.target.result,o=>{v.innerHTML="Audio decoded! Analysing audio data...",u.fft(o,null,a=>{let f=new visualscript.streams.data.InteractiveSpectrogram({data:a.slice(0,5e3),Plotly}),l=new visualscript.Tab;l.name="Interactive Spectrogram",l.controls=[{label:"colorscale",type:"select",value:f.colorscale,options:f.colorscales,onChange:r=>{f.colorscale=r.target.value}},{label:"Button Test",type:"button",onClick:()=>{console.log("CLICKED HERE!")}}],q.insertAdjacentElement("afterbegin",f),v.innerHTML="Analysis complete!",w.open=!1;let d=u.context.createBufferSource();d.buffer=o,e(d)})})};function i(s){console.log(`${s.type}: ${s.loaded} bytes transferred
`),s.type}n.addEventListener("error",i),n.readAsArrayBuffer(c)});})();
